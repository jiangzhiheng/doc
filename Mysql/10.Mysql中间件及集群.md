### 一、`DB Proxy`数据库中间件

1. 实现的功能
   - 读写分离
   - 负载均衡
   - 支持数据的分片自动路由与聚合
2. 常见中间件
   - `Mysql Proxy`：`Mysql`官方
   - `Atlas`：奇虎360
   - `DBProxy`：美团点评
   - `Amoeba`：阿里巴巴
   - `MyCat`：阿里巴巴

### 二、安装`Mycat`

1. 安装`jdk`

   ```shell
   tar xf jdk-8u60-linux-x64.tar.gz -C /root/apps/
   vim /etc/profile
   export JAVA_HOME=/root/apps/jdk
   export PATH=$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH
   export CLASSPATH=.$CLASSPATH:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$JAVA_HOME/lib/tools.jar
   source /etc/profile
   java -version
   ```

2. 安装`Mycat`

   - 下载

     `wget http://dl.mycat.org.cn/1.6-RELEASE/Mycat-server-1.6-RELEASE-20161028204710-linux.tar.gz`

   - 解压安装

     `tar xf Mycat-server-1.6-RELEASE-20161028204710-linux.tar.gz -C /root/apps/`

3. 配置示例

   - 目录结构

     ```shell
     [root@mycat mycat]# tree
     .
     ├── bin
     │   ├── dataMigrate.sh
     │   ├── init_zk_data.sh
     │   ├── mycat
     │   ├── rehash.sh
     │   ├── startup_nowrap.sh
     │   ├── wrapper-linux-ppc-64
     │   ├── wrapper-linux-x86-32
     │   └── wrapper-linux-x86-64
     ├── catlet
     ├── conf
     |	.......
     │   ├── schema.xml
     |	.......
     │   ├── server.xml   # 主配置文件
     |	.......
     │   ├── zkconf
     |	.......
     │   └── zkdownload
     │       └── auto-sharding-long.txt
     ├── lib
     │   ├── asm-4.0.jar
     |	.......
     ├── logs
     └── version.txt
     ```

   - `server.xml`：配置前段`webserver`连接中间件的账户密码

     ```xml
             <user name="root">
                     <property name="password">123456</property>
                     <property name="schemas">testdb</property>
             </user>
     ```

   - `schema.xml`：配置数值后端连接池

     ```xml
     <?xml version="1.0"?>
     <!DOCTYPE mycat:schema SYSTEM "schema.dtd">
     <mycat:schema xmlns:mycat="http://io.mycat/">
     
             <schema name="testdb" checkSQLschema="false" sqlMaxLimit="100" dataNode="dn1">
             </schema>
             <dataNode name="dn1" dataHost="hostpool" database="testdb" />
     
             <dataHost name="hostpool" maxCon="1000" minCon="10" balance="0" writeType="0" dbType="mysql" dbDriver="native" switchType="1"  slaveThreshold="100">
                     <heartbeat>select user()</heartbeat>
                     <writeHost host="master1" url="master1:3306" user="mycattest" password="123456">
                     <readHost host="slave1" url="slave1:3306" user="mycattest" password="123456" />
                     <readHost host="slave2" url="slave2:3306" user="mycattest" password="123456" />
                     </writeHost>
             </dataHost>
     </mycat:schema>
     
     ```

     **参数解析：**

     1. `balance`属性：负载均衡类型，目前的取值有三种：
        - `balance="0"`：不开启读写分离机制，所有读操作都发送到当前可用的`writeHost`上。
        - `balance="1"`：全部的`readHost`与`Standby writeHost`参与`select`语句的负载均衡，简单的说，当双主双从模式（`M1->S1,M2->S2`并且`M1`与`M2`互为主备），正常情况下，`M2,S1,S2`都参与`select`语句的负载均衡。
        - `balance="2"`：所有的读操作都随机的在`writeHost,readHost`上分发。
        - `balance="3"`：所有的读请求随机的分发到`writeHost`对应的`readHost`执行，`writeHost`不分担读压力，注意`balance=3`只支持1.4以后的版本。
     2. `writeType`属性：负载均衡属性，目前的取值有三种：
        - `writeType="0"`：所有写操作发送到配置的第一个`writeHost`，第一个挂了切换到还生存的第二个`writeHost`，重新启动后以切换后的为准
        - `writeType="1"`：所有写操作都随机的发送到配置的`writeHost`，1.5以后废弃不用。

4. 准备`Mycat`连接的用户及权限(`master`节点)

   `grant all on testdb.* to 'mycattest'@'192.168.1.109' identified by '123456';`

   `flush privileges;`

5. 启动`Mycat`

   ```shell
   [root@mycat ~]# /root/apps/mycat/bin/mycat start
   Starting Mycat-server...
   [root@mycat ~]# jps
   11792 WrapperSimpleApp
   11818 Jps
   [root@mycat ~]# ps aux|grep mycat
   # 有相关进程信息说明启动成功。
   ```

6. 测试

   ```shell
    [root@mycat ~]# netstat -tunlp |grep java
   tcp        0      0 127.0.0.1:32000         0.0.0.0:*               LISTEN      11792/java          
   tcp6       0      0 :::1984                 :::*                    LISTEN      11792/java          
   tcp6       0      0 :::8066                 :::*                    LISTEN      11792/java          
   tcp6       0      0 :::37512                :::*                    LISTEN      11792/java          
   tcp6       0      0 :::9066                 :::*                    LISTEN      11792/java          
   tcp6       0      0 :::33073                :::*                    LISTEN      11792/java 
    
    # 在客户端连接测试：
    mysql -h'192.168.1.109' -uroot -p123456 -P8066
   ....
   Server version: 5.6.29-mycat-1.6-RELEASE-20161028204710 MyCat Server (OpenCloundDB)
   ....
   mysql> 
   ```