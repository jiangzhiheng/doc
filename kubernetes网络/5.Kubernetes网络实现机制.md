一、`Kubernetes Service`官方实现

1. 概述
   - 当用户创建`Service`和对应的后端`Pod`时，`Endpoints Controller`会监控`Pod`的状态变化，当`Pod`处于`Running`且准备就绪状态时，`Endpoints Controller`会生成`Endpoints`对象
   - 运行在每个节点上的`Kube-proxy`会监控`Service`和`Endpoint`的更新，并调用其`LoadBalancer`模块在主机上刷新路由转发规则
   - `Kube-proxy`的`LoadBalancer`模块实现有`userspace,iptables,IPVS`三种，当前主流的实现方式是`iptables和IPVS`
   - `Kube-proxy`的转发模式可以通过启动参数`--proxy-mode`进行配置，有`userspace,iptables,ipvs`等选项。
2. `userspace`模式
3. `iptables`模式
   - `Kube-proxy`针对于`NodePort`流量入口专门创建了`KUBE-NODEPORTS`链，由`KUBE-NODEPORTS`链跳转到`KUBE-SVC-*`链
   - 对于`ClusterIP`访问方式，`KUBE-SERVICES`链是访问集群内服务的数据包入口点，它会根据匹配到的目标`IP:port`将数据包分发到对应的`KUBE-SVC-*`链
   - `KUBE-SVC-*`相当于一个负载均衡器，利用了`iptables`的`random`模块，它会将数据包平均分发到到`KUBE-SEP-*`链。每个`KUBE-SVC-*`后面的`KUBE-SEP-*`链都和`Service`后端的`Pod`数量一样
   - `KUBE-SEP-*`链通过`DNAT`将连接的目的地址和端口从`Service`的`IP:port`替换为后端`Pod`的`IP:port`，从而将流量转发到相应的`Pod`
   - 为了保证回程报文能够顺利返回，需要在网关处做一次`SNAT`把报文的源`IP`修改成网关`IP`地址。
4. `IPVS`模式