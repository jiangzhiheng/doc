一、通过域名访问服务：`k8s`中的`DNS`

1. `DNS`服务基本框架

   - 通常`Kubernetes`的`DNS`应用部署好后，会对外暴露一个服务，集群内的容器通过访问该服务的`Cluster IP+53`端口获得域名解析服务。
   - 容器想要获得域名解析服务，只需把`DNS Server`写入`/etc/resolv.conf`，`Kubelet`负责刷新`/etc/resolv.conf`配置
   - 通过`kubelet`的启动参数`--cluster-dns=<dns service ip>`，`DNS`的`IP`将在用户容器启动时传递，并写入每个容器的`/etc/resolv.conf`
   - 通过`kubelet`的启动参数`--cluster-domain=<default-local-domain>`参数支持配置集群域名后缀，默认是`cluster.local`

2. 域名解析基本原理

   - `Kubernetes DNS`加载项支持正向查找(`A Record`)，端口查找(`SRV`)，反向`IP`地址查找(`PTR`)及其它功能

   - 对于`Service`，`Kubernetes DNS`会生成三类`DNS`记录，分别是`A`记录，`SRV`记录，`CNAME`记录

     - `A`记录

       - `A`记录是用于将域或子域指向某个`IP`地址的`DNS`记录的最基本类型

       - `Kubernetes`为`normal`和`headless`服务分配不同的`A Record`。`headless`服务与`normal`服务的不同之处在于它们未分配`Cluster IP`且不执行负载均衡

       - 普通`Service`的`A Record`的映射关系是：

         ```shell
         {service name}.{service namespace}.svc.{domain} -> Cluster IP
         # domain:提供的域名后缀，kubelet通过--cluster-domain提供，默认cluster.local
         ```

       - `headless Service`的`A Record`的映射关系是

         ```
         {service name}.{service namespace}.svc.{domain} -> 后端Pod IP列表
         ```

     - `SRV`记录

       - `SRV`记录是通过描述某些服务协议和地址促进服务发现的，`SRV`记录通常定义一个符号名称和作为域名一部分的传输协议，并给定服务的优先级，权重，端口和目标

     - `CNAME`记录

       - `CNAME`记录用于将域或子域指向另一个主机名。一般用于联合服务的跨集群服务发现

3. `DNS`使用

   1. `Pod`的主机名由`pod.spec.name`指定，也可使用`pod.spec.subdomain`自定义子域名，定义后`Pod`的`FQDN`将变为`<hostname>.<subdomain>.<pod namespace>.svc.<cluster domain>`

   2. `DNS`测试

      - 创建测试`Pod`

        ```yaml
        apiVersion: v1
        kind: Pod
        metadata:
          name: busybox
          namespace: default
        spec:
          containers:
          - name: busybox
            image: busybox:1.28
            command:
            - sleep
            - "3600"
            imagePullPolicy: IfNotPresent
          restartPolicy: Always
        ```

      - 测试解析`kubernetes`默认`API Server`的`service`地址

        ```shell
        [root@master ~]# kubectl exec -it busybox -- nslookup kubernetes.default
        Server:    10.96.0.10
        Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local
        
        Name:      kubernetes.default
        Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local
        ```

        ```shell
        [root@master ~]# kubectl exec -it busybox -- cat /etc/resolv.conf
        nameserver 10.96.0.10
        search default.svc.cluster.local svc.cluster.local cluster.local localdomain jzh.com
        options ndots:5
        # options ndots:5的含义是当查询的域名字符串内的点字符超过5个时，则认为是完整域名，直接解析，否则Linux系统会自动尝试用default.svc.cluster.local svc.cluster.local cluster.local 补齐域名后缀，查询过程中任意一个记录匹配便返回
        ```

4. `Kubernetes`域名解析策略：

   `Kubernetes`域名解析策略对应到`Pod`配置中的`dnsPolicy`，有四种可选策略：

   - `None`：`kubernetes 1.9+`新引入，它允许`Pod`忽略`Kubernetes`环境中的`DNS`设置，应使用`dnsConfigPod`规范中所提供的`DNS`设置。

     - 示例：

       ```yaml
       apiVersion: v1
       kind: Pod
       metadata:
         name: dns-none-policy
         namespace: default
       spec:
         containers:
         - name: test
           image: nginx:1.14-alpine
           imagePullPolicy: IfNotPresent
         dnsPolicy: "None"
         dnsConfig:
           nameservers:
           - 1.2.3.4
           searches:
           - ns1.svc.cluster.local
           - my.dns.search.suffix
           options:
           - name: ndots
             value: "2"
           - name: edns0
       ```

     - 验证

       ```shell
       [root@master testDns]# kubectl exec -it dns-none-policy -- cat /etc/resolv.conf
       nameserver 1.2.3.4
       search ns1.svc.cluster.local my.dns.search.suffix
       options ndots:2 edns0
       ```

   - `ClusterFirstWithHostNet`：对于使用`hostNetwork`运行的`Pod`，用户应该明确设置其`DNS`策略为`ClusterFirstWithHostNet`

     ```yaml
     ...
     spec:
       ...
       hostNetwork: true
       dnsPolicy: ClusterFirstWithHostNet
       ...
     
     # 对于使用主机网络的Pod，它们是可以直接访问宿主机的/etc/resolv.conf文件的，如果不添加dnsPolicy: ClusterFirstWithHostNet，Pod将会默认使用宿主机的DNS配置，这样会导致集群内容器无法通过域名访问kubernetes的服务，除非在宿主机的/etc/resolv.conf文件配置了kubernetes的DNS服务器
     ```

   - `ClusterFirst`：任何与配置的群集域后缀(例如`cluster.local`)不匹配的`DNS`查询，将转发到从宿主机上继承的上游域名服务器。集群管理员可以根据需要配置上游`DNS`服务器，默认选项。

     - `ClusterFirst`策略就是优先使用`Kubernetes`的`DNS`服务解析，失败后再使用外部级联的`DNS`服务解析

   - `Default`：`Pod`从宿主机上继承名称解析配置

5. `DNS`调试步骤：

   - 查看容器中的`resolv.conf`，验证是否正确设置了搜索路径和名称服务器。
   - 如果`resolv.conf`条目都是正确的，检查`kube-dns/coredns`插件是否启动，对应的`pod`是否运行
   - 检查后端`DNS Endpoint`是否准备好

