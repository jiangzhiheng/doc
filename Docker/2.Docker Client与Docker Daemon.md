一、`Docker Client`创建与命令执行

1. 创建`Docker Client`

   1. `Docker`命令的`flag`参数解析

      - 对于`Docker`请求中的参数，分为两类

        - 命令行参数，即`Docker`程序运行时所需提供的参数，如`-D,--daemon=true,--daemon=false`等。即`flag`参数
        - `docker`发送给`Docker Server`的实际请求参数，如：`ps,pull NAME`等

      - `Docker`中对于命令行参数的解析使用`Golang`中的`flag`包实现，

        `flag包的使用：https://www.jianshu.com/p/f9cf46a4de0e`

   2. 创建`Docker Client`

      通过`client.NewDockerCli`函数，创建一个`Docker Client`实例`cli`
      
      `Docker Client`主要有两方面的工作：
      
      - 解析请求命令(经`flag`解析后存放于`flag.Arg()`)，得出请求类型；
      - 执行具体类型的请求

2. `Docker`命令执行

   1. `Docker Client`解析请求命令(通过`cli.Cmd`方法解析`flag.Arg()`中的参数)
   2. `Docker Client`执行请求命令



二、启动`Docker Daemon`

1. `Docker Daemon`的启动流程

   ![DockerDaemon启动流程.png](http://ww1.sinaimg.cn/large/d3f19072gy1gbp3hpdtzkj20bh0cm76i.jpg)

   

2. `mainDaemon`的具体实现

   - `mainDaemon`的主要功能：

     - 创建`Docker`运行环境
     - 服务于`Docker Client`，接收并处理相应请求(完成`Docker Server`的初始化)

   - `mainDaemon`的主要步骤

     - `daemon`的配置初始化，这部分在`init`函数中实现

       ```go
       var (
           daemonCfg = &daemon.Config{}
       )
       
       
       /*Config对象的定义如下*/
       type Config struct {
           Pidfile string
           Root	string
           AutoRestart	bool
           Dns		[]string
           DnsSearch	[]string
           Mirrors		[]string //指定docker registry的地址
           EnableIptables bool
           EnableIpForward
           EnableIpMasq	//启用IP伪装
           ....
       }
       
       func init(){
           daemonCfg.InstallFlags()
       }
       //daemonCfg.InstallFlags()函数实现各属性的赋值或初始化（利用flag包中的方法）
       ```

     - 命令行`flag`参数检查

       ```go
       if flag.NArg() != 0{  
           /*docker命令经过flag参数解析之后剩余的参数是否为0，若为0，则说明是启动docker daemon的命令，否则（参考client 的创建与命令执行），返回usage
           */
           flag.Usage()
           return
       }
       ```

     - 创建`engine`对象

     - 设置`engine`的信号捕获及处理方法

     - 加载`builtins`

     - 使用`goroute`加载`daemon`对象并运行

     - 打印`Docker`版本及驱动信息

     - `serveapi`的创建与运行

3. 