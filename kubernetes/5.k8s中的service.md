一、`Service`资源

1. `service`的三种代理模式

   1. `userspace`代理(1.1-)

      ![userspace.png](http://ww1.sinaimg.cn/large/d3f19072gy1gc9noibdcmj20mw0f879b.jpg)

   2. `iptables`代理(1.10-)

      ![iptables.png](http://ww1.sinaimg.cn/large/d3f19072gy1gc9nowne5lj20mn0eo438.jpg)

   3. `ipvs`代理

      ![ipvs.png](http://ww1.sinaimg.cn/large/d3f19072gy1gc9np8bu43j20mz0eoq82.jpg)

2. `service`定义核心字段

   - `apiVersion`：`v1`
   - `kind`：`Service`
   - `metadata`
   - `spec`
     - `type <string>`：`service`类型
       - `ClusterIP`：分配一个集群内部`IP`用于负载均衡到各`endpoint`
       - `NodePort`：用于集群外部通过节点访问集群内资源
       - `LoadBalancer`：创建一个外部的负载均衡（配合`LBAAS`使用）
       - `ExternalName`：用于集群内部客户端访问集群外部服务
     - `selector <map[string]string>`：配置标签选择器用于匹配指定的`pod`资源
     - `ports	<[]Object>`：
       - `name <string>`
       - `nodePort <integer>`：指定节点上暴露的端口，只有`type=NodePort`才可用
       - `port	<integer> -required-`：`service`上的暴露端口
       - `targetPort	<string>`：`Pod`资源上的服务端口
     - `clusterIP	<string>`：手动指定`service`上的`IP`，默认自动分配
     - `sessionAffinity <string>`：会话粘性。同一客户端的访问调度到同一`pod`，`Supports "ClientIP" and "None".`
     - `externalName <string>`：配置访问集群外部服务

3. `clusterIP`示例

   ```yaml
   apiVersion: v1
   kind: Service
   metadata:
     name: myapp01
     namespace: default
   spec:
     selector:   # 匹配pod资源中的label
       app: myapp
       release: canary
     clusterIP: 10.97.97.97  #手动指定service IP
     type: ClusterIP
     ports:
     - port: 80
       targetPort: 80
   ```

4. `NodePort`示例

   ```yaml
   apiVersion: v1
   kind: Service
   metadata:
     name: myapp
     namespace: default
   spec:
     selector:
       app: myapp
       release: canary
     clusterIP: 10.99.99.99
     type: NodePort
     ports:
     - port: 80
       targetPort: 80
       nodePort: 30080
   ```

5. `headless`：无头服务

   ```yaml
   apiVersion: v1
   kind: Service
   metadata:
     name: myapp-headless
     namespace: default
   spec:
     selector:
       app: myapp
       release: canary
     clusterIP: "None"   #指定ClusterIP 为None ，dns解析时会直接解析到pod IP
     ports:
     - port: 80
       targetPort: 80
   ```

   ```shell
   # 测试无头服务
   [root@master service]# dig -t A myapp-headless.default.svc.cluster.local. @10.96.0.10
   
   ; <<>> DiG 9.11.4-P2-RedHat-9.11.4-9.P2.el7 <<>> -t A myapp-headless.default.svc.cluster.local. @10.96.0.10
   h
   ;; OPT PSEUDOSECTION:
   ; EDNS: version: 0, flags:; udp: 4096
   ;; QUESTION SECTION:
   ;myapp-headless.default.svc.cluster.local. IN A
   
   ;; ANSWER SECTION:
   myapp-headless.default.svc.cluster.local. 5 IN A 10.244.1.33
   myapp-headless.default.svc.cluster.local. 5 IN A 10.244.2.41
   myapp-headless.default.svc.cluster.local. 5 IN A 10.244.2.42
   # .....
   ```



   