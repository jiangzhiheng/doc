一、存储卷

1. `k8s`中的存储卷类型

   `kubectl explain pods.spec.volumes`

   - `awsElasticBlockStore <Object>`：`AWS`的块存储
   - `azureDisk	<Object>`：微软的块存储
   - `azureFile	<Object>`：微软的文件系统级别存储
   - `cephfs	<Object>`：`ceph`文件存储
   - `cinder	<Object>`：`openstack`云存储
   - `emptyDir <Object>`：空目录，常用作临时目录或缓存
   - `fc	<Object>`：`FC`共享存储
   - `hostPath <Object>`：节点级别的存储目录
   - `iscsi <Object>`：`iSCSI`共享存储
   - `nfs <Object>`：`NAS`共享存储
   - `glusterfs	<Object>`：`gluster`文件存储
   - .....

2. `emptyDir`示例

   `kubectl explain pods.spec.volumes.emptyDir`

   - `emptyDir`核心字段

     - `emptyDir <Object>`
       - `medium	<string>`：媒介类型，默认为`""`(磁盘)，还可以为`Memory`
       - `sizeLimit	<string>`：空间上限

   - 容器中挂载：

     `kubectl explain pods.spec.containers.volumeMounts`

     - `volumeMounts <[]Object>`
       - `mountPath	<string> -required-`：挂载路径
       - `name	<string> -required-`：存储卷名称，匹配`pod`中定义的存储卷
       - `readOnly	<boolean>`：是否挂载为只读
       - `subPath	<string>`

   - `emptyDir`示例

     ```yaml
     apiVersion: v1
     kind: Pod
     metadata:
       name: volume-demo
       namespace: default
       labels:
         app: myapp
         tier: frontend
       annotations:
         jzh/created-by: "cluster-admin"
     spec:
       containers:
       - name: myapp
         image: ikubernetes/myapp:v1
         ports:
         - name: http
           containerPort: 80
         volumeMounts:
         - name: html
           mountPath: /usr/share/nginx/html
       - name: busybox
         image: busybox:latest
         imagePullPolicy: IfNotPresent
         volumeMounts:
         - name: html
           mountPath: /data/
         command: ["/bin/sh"]
         args: ["-c","while true;do echo $(date)>>/data/index.html;sleep 2;done"]
       volumes:
       - name: html
         emptyDir
         
     # busybox容器实现类似sidecar功能做为辅助容器为主容器提供网页内容
     ```

3. `gitRepo <Object>`：使用`git`仓库中的内容在`pod`启动时将仓库中的资源`clone`到存储卷中

   - `gitRepo <Object>`
     - `directory <string>`
     - `repository <string> -required-`
     - `revision <string>`

4. `hostPath <Object>`存储卷

   - `path <string> -required-`：节点上的路径

   - `type <string>`：`Type for HostPath Volume Defaults to "" `

     - `DirectoryOrCreate`
     - `Directory`
     - `FileOrCreate`
     - `File`
     - `Socket`
     - `CharDevice`
     - `BlockDevice`

     `https://kubernetes.io/docs/concepts/storage/volumes/#hostpath`

   - `hostPath`示例

     ```yaml
     apiVersion: v1
     kind: Pod
     metadata:
       name: pod-vol-hostpath
       namespace: default
     spec:
       containers:
       - name: myapp
         image: ikubernetes/myapp:v1
         volumeMounts:
         - name: html
           mountPath: /usr/share/nginx/html/
       volumes:
       - name: html
         hostPath:
           path: /data/pod/volume1
           type: DirectoryOrCreate
     ```

5. `nfs `存储卷

   - `nfs <Object>`核心字段

     - `path <string> -required-`：`NFS server`导出的目录
     - `server	<string> -required-`：`NFS server`的地址

   - `nfs`存储卷示例

     ```yaml
     apiVersion: v1
     kind: Pod
     metadata:
       name: pod-nfs-vol
       namespace: default
     spec:
       containers:
       - name: myapp
         image: ikubernetes/myapp:v1
         volumeMounts:
         - name: html
           mountPath: /usr/share/nginx/html/
       volumes:
       - name: html
         nfs:
           path: /data/volumes
           server: 192.168.1.10
     ```

     示例：配置`master`节点做为`nfs server`

     ```shell
     yum -y install nfs-utils  #三个节点都要安装
     mkdir /data/volumes -p
     echo "/data/volumes    172.16.100.0/24(rw,no_root_squash)" >> /etc/exports
     systemctl start nfs
     systemctl enable nfs
     echo "nfs server" >> /data/volumes/index.html
     ```

6. `PVC`及其使用

   1. 原理

      - 逻辑架构

        ![pvc原理.png](http://ww1.sinaimg.cn/large/d3f19072gy1gcc50or7aaj20ni0fq11w.jpg)

      - 生产者消费者模型

        ![pvc原理2.png](http://ww1.sinaimg.cn/large/d3f19072gy1gcc51c6mgrj20lg0b17by.jpg)

   2. 准备存储环境

      ```shell
      mkdir /data/volumes/v{1,2,3,4,5}
      echo "/data/volumes/v1    172.16.100.0/24(rw,no_root_squash)" >>/etc/exports 
      echo "/data/volumes/v2    172.16.100.0/24(rw,no_root_squash)" >>/etc/exports
      echo "/data/volumes/v3    172.16.100.0/24(rw,no_root_squash)" >>/etc/exports
      echo "/data/volumes/v4    172.16.100.0/24(rw,no_root_squash)" >>/etc/exports
      echo "/data/volumes/v5    172.16.100.0/24(rw,no_root_squash)" >>/etc/exports
      systemctl restart nfs
      ```

   3. 配置`PV`资源

      - `PV`资源核心字段

        - `apiVersion`：`v1`
        - `kind`：`PersistentVolume`
        - `metadata	<Object>`：特别指出，`PV`属于集群级别资源，不可指定名称空间
        - `spec	<Object>`
          - `accessModes <[]string>`：访问模型
            - `ReadWriteOnce`
            - `ReadOnlyMany`
            - `ReadWriteMany`
          - `capacity <map[string]string>`：定义`pv`的容量
            - `storage`：`(Ei, Pi, Ti, Gi, Mi, Ki)`
          - `persistentVolumeReclaimPolicy	<string>`：资源回收策略
            - `Retain`
            - `Delete`
            - `Recycle`
          - `nfs <Object>`
          - `iscsi	<Object>`
          - ......

      - `pv`定义示例

        ```yaml
        apiVersion: v1
        kind: PersistentVolume
        metadata:
          name: pv001
          labels:
            name: pv001
        spec:
          nfs:
            path: /data/volumes/v1
            server: master
          accessModes: ["ReadWriteMany","ReadWriteOnce"]
          capacity:
            storage: 1Gi
        ---
        
        apiVersion: v1
        kind: PersistentVolume
        metadata:
          name: pv002
          labels:
            name: pv002
        spec:
          nfs:
            path: /data/volumes/v2
            server: master
          accessModes: ["ReadWriteMany","ReadWriteOnce"]
          capacity:
            storage: 2Gi
        ---
        apiVersion: v1
        kind: PersistentVolume
        metadata:
          name: pv003
          labels:
            name: pv003
        spec:
          nfs:
            path: /data/volumes/v3
            server: master
          accessModes: ["ReadWriteMany","ReadWriteOnce"]
          capacity:
            storage: 500Mi
        ---
        
        apiVersion: v1
        kind: PersistentVolume
        metadata:
          name: pv004
          labels:
            name: pv004
        spec:
          nfs:
            path: /data/volumes/v4
            server: master
          accessModes: ["ReadWriteMany","ReadWriteOnce"]
          capacity:
            storage: 3Gi
        ---
        apiVersion: v1
        kind: PersistentVolume
        metadata:
          name: pv005
          labels:
            name: pv005
        spec:
          nfs:
            path: /data/volumes/v5
            server: master
          accessModes: ["ReadWriteMany","ReadWriteOnce"]
          capacity:
            storage: 10Gi
        ```

        ```shell
        [root@master volumes]# kubectl get pv
        NAME      CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM     STORAGECLASS   REASON    AGE
        pv001     1Gi        RWO,RWX        Retain           Available                                      5s
        pv002     2Gi        RWO,RWX        Retain           Available                                      5s
        pv003     500Mi      RWO,RWX        Retain           Available                                      5s
        pv004     3Gi        RWO,RWX        Retain           Available                                      5s
        pv005     10Gi       RWO,RWX        Retain           Available                                      5s
        ```

   4. `pvc`资源定义

      - `PersistentVolumeClaim`核心字段

        - `apiVersion`：`v1`
        - `kind`：`PersistentVolumeClaim`
        - `metadata`
        - `spec`：
          - `accessModes	<[]string>`：访问模型，参考`pv`的定义
          - `resources	<Object>`：资源，定义需要请求空间大小
          - `volumeName	<string>`

      - 资源定义示例

        ```yaml
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: mypvc
          namespace: default
        spec:
          accessModes: ["ReadWriteMany"]
          resources:
            requests:
              storage: 2Gi
        ---
        apiVersion: v1
        kind: Pod
        metadata:
          name: pod-pvc-vol
          namespace: default
        spec:
          containers:
          - name: myapp
            image: ikubernetes/myapp:v1
            volumeMounts:
            - name: html
              mountPath: /usr/share/nginx/html/
          volumes:
          - name: html
            persistentVolumeClaim:
              claimName: mypvc
        ```

        结果验证：

        ```shell
        [root@master volumes]# kubectl get pvc
        NAME      STATUS    VOLUME    CAPACITY   ACCESS MODES   STORAGECLASS   AGE
        mypvc     Bound     pv002     2Gi        RWO,RWX                       10s
        
        [root@master volumes]# kubectl get pv
        NAME      CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM           STORAGECLASS   REASON    AGE
        pv001     1Gi        RWO,RWX        Retain           Available                                            37m
        pv002     2Gi        RWO,RWX        Retain           Bound       default/mypvc                            37m
        pv003     500Mi      RWO,RWX        Retain           Available                                            37m
        pv004     3Gi        RWO,RWX        Retain           Available                                            37m
        pv005     10Gi       RWO,RWX        Retain           Available                               			 37m
        
        ```

   5. 

7. 