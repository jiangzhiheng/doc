一、从部署一个`Nginx`开始

1. 创建`pod`

   ```shell
   [root@master ~]# kubectl run nginx-deploy --image=nginx:1.14-alpine --port=80 --replicas=1 
   deployment.apps/nginx-deploy created
   [root@master ~]# kubectl get pods -o wide
   NAME                          READY     STATUS    RESTARTS   AGE       IP           NODE      NOMINATED
   nginx-deploy-5b595999-rqfbs   1/1       Running   0          4s        10.244.2.4   node2     <none>
   ```

2. 创建`service`

   ```shell
   [root@master ~]# kubectl expose deployment nginx-deploy --name=nginx --port=80 --protocol=TCP
   service/nginx exposed
   [root@master ~]# kubectl get svc
   NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
   kubernetes   ClusterIP   10.96.0.1       <none>        443/TCP   20h
   nginx        ClusterIP   10.96.228.220   <none>        80/TCP    8s
   ```

3. 修改`service`类型实现集群外部访问

   ```shell
   [root@master ~]# kubectl edit svc nginx
   # 修改service类型为NodePort
   ```

4. 删除一个资源

   ```shell
   [root@master ~]# kubectl get deploy
   NAME           DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
   client         1         1         1            1           3m
   nginx-deploy   1         1         1            1           5m
   [root@master ~]# kubectl get svc
   NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE
   kubernetes   ClusterIP   10.96.0.1        <none>        443/TCP        9m
   nginx        NodePort    10.100.232.192   <none>        80:30809/TCP   3m
   [root@master ~]# kubectl delete svc nginx
   service "nginx" deleted
   [root@master ~]# kubectl delete deploy nginx-deploy
   deployment.extensions "nginx-deploy" deleted
   ```

5. 使用`scale`扩容`pod`副本

   ```shell
   [root@master ~]# kubectl run myapp --image=ikubernetes/myapp:v1 --port=80 --replicas=2
   deployment.apps/myapp created
   [root@master ~]# kubectl get pods -o wide -w
   NAME                      READY     STATUS    RESTARTS   AGE       IP            NODE      NOMINATED NODE
   client-7c9999bd74-tcbbv   1/1       Running   0          6m        10.244.2.9    node2     <none>
   myapp-6865459dff-5q56h    1/1       Running   0          13s       10.244.1.5    node1     <none>
   myapp-6865459dff-pb22m    1/1       Running   0          13s       10.244.2.10   node2     <none>
   
   #***********************************************************************
   [root@master ~]# kubectl scale --replicas=5  deployment myapp   #增加pod副本数
   deployment.extensions/myapp scaled
   [root@master ~]# kubectl get pods -o wide -w
   NAME                      READY     STATUS    RESTARTS   AGE       IP            NODE      NOMINATED NODE
   client-7c9999bd74-tcbbv   1/1       Running   0          13m       10.244.2.9    node2     <none>
   myapp-6865459dff-27rkf    1/1       Running   0          10s       10.244.1.6    node1     <none>
   myapp-6865459dff-485fl    1/1       Running   0          10s       10.244.2.11   node2     <none>
   myapp-6865459dff-5q56h    1/1       Running   0          6m        10.244.1.5    node1     <none>
   myapp-6865459dff-pb22m    1/1       Running   0          6m        10.244.2.10   node2     <none>
   myapp-6865459dff-sg6fv    1/1       Running   0          10s       10.244.1.7    node1     <none>
   
   # 缩容
   [root@master ~]# kubectl scale --replicas=2  deployment myapp
   deployment.extensions/myapp scaled
   [root@master ~]# kubectl get pods -o wide -w
   NAME                      READY     STATUS        RESTARTS   AGE       IP            NODE      NOMINATED NODE
   client-7c9999bd74-tcbbv   1/1       Running       0          16m       10.244.2.9    node2     <none>
   myapp-6865459dff-27rkf    0/1       Terminating   0          3m        10.244.1.6    node1     <none>
   myapp-6865459dff-485fl    0/1       Terminating   0          3m        10.244.2.11   node2     <none>
   myapp-6865459dff-5q56h    1/1       Running       0          9m        10.244.1.5    node1     <none>
   myapp-6865459dff-pb22m    1/1       Running       0          9m        10.244.2.10   node2     <none>
   myapp-6865459dff-sg6fv    0/1       Terminating   0          3m        10.244.1.7    node1     <none>
   ```

   启动一个客户端`pod`

   ```shell
   root@master ~]# kubectl run client --image=busybox --replicas=1 -it
   / # wget -O - -q 10.244.1.5
   Hello MyApp | Version: v1 | <a href="hostname.html">Pod Name</a>
   / # wget -O - -q 10.244.2.10
   Hello MyApp | Version: v1 | <a href="hostname.html">Pod Name</a>
   / # wget -O - -q myapp
   Hello MyApp | Version: v1 | <a href="hostname.html">Pod Name</a>
   / # while true;do wget -O - -q myapp;sleep 1 ;done
   Hello MyApp | Version: v2 | <a href="hostname.html">Pod Name</a>
   Hello MyApp | Version: v2 | <a href="hostname.html">Pod Name</a>
   Hello MyApp | Version: v2 | <a href="hostname.html">Pod Name</a>
   Hello MyApp | Version: v2 | <a href="hostname.html">Pod Name</a>
   ```

6. 使用`rollout`实现版本更新或回滚

   ```shell
   # 版本升级
   [root@master ~]# kubectl set image deployment myapp myapp=ikubernetes/myapp:v2
   deployment.extensions/myapp image updated
   [root@master ~]# kubectl rollout status deploy myapp
   Waiting for deployment "myapp" rollout to finish: 1 out of 3 new replicas have been updated...
   Waiting for deployment "myapp" rollout to finish: 1 out of 3 new replicas have been updated...
   Waiting for deployment "myapp" rollout to finish: 1 out of 3 new replicas have been updated...
   Waiting for deployment "myapp" rollout to finish: 2 out of 3 new replicas have been updated...
   Waiting for deployment "myapp" rollout to finish: 2 out of 3 new replicas have been updated...
   Waiting for deployment "myapp" rollout to finish: 2 out of 3 new replicas have been updated...
   Waiting for deployment "myapp" rollout to finish: 1 old replicas are pending termination...
   Waiting for deployment "myapp" rollout to finish: 1 old replicas are pending termination...
   deployment "myapp" successfully rolled out
   [root@master ~]#
   
   # 版本回滚，默认回滚到上一个版本
   [root@master ~]# kubectl rollout undo deployment myapp
   deployment.extensions/myapp
   
   ```