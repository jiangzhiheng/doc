一、`k8s`认证及`serviceaccount`

1. `k8s`认证流程

   - 认证（身份识别）：
     - `Token`认证
     - `SSL`认证
   - 授权(权限检查)：
   - 准入控制：(主要是对授权的一些补充)

2. 客户端向`api server`发起的请求信息：

   - `user`：`username,uid`

   - `group`

   - `extra`

   - `API:Request path`：

     例如：`http://192.168.1.145:6443/apis/v1/namespaces/default/deployments/myapp/`

   - `HTTP Request verb`：`get,post,put,delete`

   - `API Request`：`get,list,create,update,patch,watch,proxy,rediect,delete,deletecellection`

   - `Resource`

   - `Subsource`

   - `Namespace`

   - `API Group`

3. `serviceAccount`：用于集群内的资源如`pod`跟`api server`通信时作认证用

   1. 主要字段

      - `apiVersion`：`v1`
      - `kind`：`ServiceAccount`
      - `metadata`
      - `imagePullSecrets <[]Object>`：安全起见，在配置`pod`中的镜像使用私有`registry`时，通过定义`secret`，并将`secret`定义在`service account`中
      - `secrets <[]Object>`

   2. 创建`serviceAccount`方法

      - 通过命令直接创建

        ```shell
        kubectl create serviceaccount my-service-account
        
        [root@master ~]# kubectl get sa my-service-account -o yaml
        apiVersion: v1
        kind: ServiceAccount
        metadata:
          creationTimestamp: 2020-03-02T03:14:49Z
          name: my-service-account
          namespace: default
          resourceVersion: "64631"
          selfLink: /api/v1/namespaces/default/serviceaccounts/my-service-account
          uid: f9ca11df-5c33-11ea-8b58-000c2928afcb
        secrets:
        - name: my-service-account-token-bdjdk
        ```

      - 通过清单文件创建

4. 将自定义`serviceAccount`使用在`pod`定义中

   ```yaml
   apiVersion: v1
   kind: Pod
   metadata:
     name: pod-demo01
     namespace: default
     labels:
       app: myapp
       tier: frontend
     annotations:
       jzh.master/create-by: "cluster admin"
   spec:
     containers:
     - name: myapp
       image: nginx:1.13-alpine
       ports:
       - name: http
         containerPort: 80
     serviceAccountName: my-service-account
   ```

二、授权管理之`RBAC`

1. `apiServer`的客户端访问`apiServer`的配置文件：`kubeconfig`

   ```shell
   [root@master ~]# kubectl config view
   apiVersion: v1
   clusters:   # 集群列表，kubectl可以管理多个集群
   - cluster:
       certificate-authority-data: REDACTED
       server: https://192.168.1.145:6443
     name: kubernetes
   contexts:   #上下文列表，定义了哪个用户访问那个集群
   - context:
       cluster: kubernetes
       user: kubernetes-admin
     name: kubernetes-admin@kubernetes
   current-context: kubernetes-admin@kubernetes
   kind: Config
   preferences: {}
   users:      # 用户列表
   - name: kubernetes-admin
     user:
       client-certificate-data: REDACTED
       client-key-data: REDACTED
   
   ```

2. 创建自定义账户

   1. 创建基于`SSL`认证类型`kubernetes`集群自定义账户时，需要使用集群认可的`CA`签发证书，集群私有的`CA`位于`/etc/kubernetes/pki{ca.crt,ca.key}`

   2. 创建私钥并基于私钥签署证书

      ```shell
      [root@master ~]# cd /etc/kubernetes/pki/
      # 创建私钥
      [root@master pki]# (umask 077; openssl genrsa -out myadmin.key 2048)
      # 生成证书签发请求，并签发证书
      [root@master pki]# openssl req -new -key myadmin.key -out myadmin.csr -subj "/CN=myadmin"
      [root@master pki]# openssl x509 -req -in myadmin.csr -CA ./ca.crt -CAkey ./ca.key -CAcreateserial -out myadmin.crt -days 365
      ```

   3. 创建`user`：

      ```shell
      [root@master pki]# kubectl config set-credentials myadmin --client-certificate=./myadmin.crt --client-key=./myadmin.key --embed-certs=true
      
      # --embed-certs=true 隐藏证书中的信息，显示为REDACTED
      ```

   4. 创建`context`

      ```shell
      [root@master ~]# kubectl config set-context myadmin@kubernetes --cluster=kubernetes --user=myadmin
      ```

      ```yaml
      [root@master ~]# kubectl config view
      apiVersion: v1
      clusters:
      - cluster:
          certificate-authority-data: REDACTED
          server: https://192.168.1.145:6443
        name: kubernetes
      contexts:
      - context:
          cluster: kubernetes
          user: kubernetes-admin
        name: kubernetes-admin@kubernetes
      - context:   # 新添加的context
          cluster: kubernetes
          user: myadmin
        name: myadmin@kubernetes
      current-context: kubernetes-admin@kubernetes
      kind: Config
      preferences: {}
      users:
      - name: kubernetes-admin
        user:
          client-certificate-data: REDACTED
          client-key-data: REDACTED
      - name: myadmin  # 自定义的用户
        user:
          client-certificate-data: REDACTED
          client-key-data: REDACTED
      
      ```

   5. 切换用户测试

      ```shell
      [root@master ~]# kubectl config use-context myadmin@kubernetes
      Switched to context "myadmin@kubernetes".
      [root@master ~]# kubectl get pods
      No resources found.
      Error from server (Forbidden): pods is forbidden: User "myadmin" cannot list pods in the namespace "default"
      
      # 由于新创建用户未授权，所以获取pod资源失败
      ```

   6. `kubectl`客户端工具可以同时管理多个集群，添加集群方式为：

      ```shell
      [root@master ~]# kubectl config set-cluster mycluster --kubeconfig=/tmp/test.conf --server="https://172.16.100.60:6443" --certificate-authority=/etc/kubernetes/pki/ca.crt --embed-certs=true
      
      # 注意：可以通过--kubeconfig手动指定kubectl访问集群的配置文件
      # --certificate-authority用于指定要添加的集群私有证书认证机构，也就是/etc/kubernetes/pki/ca.crt
      
      [root@master ~]# kubectl config view --kubeconfig=/tmp/test.conf 
      apiVersion: v1
      clusters:
      - cluster:
          certificate-authority-data: REDACTED
          server: https://172.16.100.60:6443
        name: mycluster
      contexts: []
      current-context: ""
      kind: Config
      preferences: {}
      users: []
      ```

3. 授权插件种类

4. `RBAC`概念及使用