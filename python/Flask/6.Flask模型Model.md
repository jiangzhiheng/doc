### 一、简介

1. 概述：

   `Flask`作为一款`MVC`框架，也提供`ORM`功能

   **使用`ORM`**? 随着项目越来越大，采用原生`SQL`的方式，在代码中会出现大量的`SQL`语句，那么会出现如下问题：

   - `SQL`语句重复使用率不高，越复杂的`SQL`语句条件就越多，代码也会越长，会出现跟多相似的`SQL`语句
   - 跟多`SQL`语句是在业务逻辑中拼出来的，如果有数据库需要更改，就需要去更改这些逻辑，这样就会容易漏掉对某些`SQL`语句的修改

   **`ORM`概述**

   - `ORM`中文成为对象关系映射，通过`ORM`我们可以通过类的方式操作数据库，而不用写原生的`SQL`，通过表映射成类，把行作为实例，把字段作为属性。
   - `ORM`在执行对象操作的时候，最终还是会把对应的操作转换为数据库原生`SQL`语句。

   **使用好处：**

   - 易用性：使用`ORM`做数据库开发，可以有效的较少重复`SQL`语句的概率，写出来的模型也更加直观清晰
   - 设计灵活：可以轻松的写出复杂的`SQL`语句
   - 可移植性：`SQLalchemy`封装了底层的数据库实现，支持多个关系数据库引擎包括流行的`Mysql,sqlite`等。
   - 性能损耗小：`ORM`转换成底层数据库操作指令会有一些开销，但从实际情况来看，这种性能损耗很小，只要不是对性能有严苛的要求，综合开发效率，代码的阅读性，带来的好处要远远大于性能损耗，而且项目越大越明显。

### 二、前期准备

1. 在`Mysql`中创建数据库

   `create database 数据库名称 character set utf8`

2. 安装`pymysql`驱动

   `pip install pymysql`

3. 安装`flask-sqlachemy`

   `pip install flash-sqlalchemy`

4. 导入与配置

   ```python
   from flask import Flask
   from flask_script import Manager
   from flask_sqlalchemy import SQLAlchemy
   
   app = Flask(__name__)
   # 配置数据库连接
   app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql+pymysql://root:12345@192.168.1.129:3306/testdb'
   # 是否追踪数据的改变，发出井盖
   app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
   # 实例化ORM模型
   db = SQLAlchemy(app)
   manager = Manager(app)
   ```

### 三、设计模型

1. 常见字段类型

   |    类型名称    |    `Python`类型     |           说明            |
   | :------------: | :-----------------: | :-----------------------: |
   |   `Integer`    |        `int`        |         存储整型          |
   | `SmallInteger` |        `int`        |          小整型           |
   |  `BigInteger`  |        `int`        |          长整型           |
   |    `Float`     |       `float`       |          浮点型           |
   |    `String`    |        `str`        | 字符串（不是长`varchar`） |
   |     `Text`     |        `str`        |         大型文本          |
   |   `Boolean`    |       `bool`        |         布尔类型          |
   |     `Date`     |   `datetime.date`   |           日期            |
   |     `Time`     |   `datatime.date`   |           时间            |
   |   `DateTime`   | `datetime.datetime` |        日期和时间         |

2. 可选约束条件

   |     选项      |             说明              |
   | :-----------: | :---------------------------: |
   | `primary_key` |     是否主键，默认`False`     |
   |   `unique`    |   是否唯一索引，默认`False`   |
   |    `index`    | 是否设置常规索引，默认`False` |
   |  `nullable`   |  是否可以为空，默认为`True`   |
   |   `default`   |          设置默认值           |

   注意：

   - `flask-sqlalchemy`要求每个模型都要有一个主键
   - 默认可以为空，设置默认值的时候并不是更改表的结构设置默认值，而是在你没有给当前属性值得时候，会把默认值作为值进行传入

### 四、创建模型

1. 创建一个`user`模型类

   实例：

   ```python
   # 创建user模型
   class user(db.Model):
       __tablename__ = 'user'  # 表名，默认为类名
       id = db.Column(db.Integer,primary_key=True)
       username = db.Column(db.String(10),default='martin',index=True)
       age = db.Column(db.Integer,default=18)
       sex = db.Column(db.Boolean,default=True)
       info = db.Column(db.String(50),default='个人简介')
      
       def __str__(self):
           return 'username: '+ self.username
   ```

2. 创建表

   ```python
   # 创建表
   @app.route('/create/')
   def create():
       db.create_all()
       return '创建表'
   ```

3. 删除表

   ```python
   # 删除表
   @app.route('/drop/')
   def drop():
       db.drop_all()
       return '删除表'
   ```

### 五、数据增删改查

1. 添加数据`add`

   实例1：

   ```python
   # 添加一条数据
   @app.route('/insert_one/')
   def insert_one():
       try:
           data = User()
           data.username = 'martin'
           data.age = 18
           data.sex = False
           data.info = '测试添加一条数据'
           db.session.add(data)
           # 事务提交
           db.session.commit()
       except:
           # 事物回滚
           db.session.rollback()
       return '添加一条数据'
   ```

   实例2：

   ```python
   # 添加一条数据
   @app.route('/insert_one/')
   def insert_one():
       try:
           u = User(username='martin1',age=21,sex=True,info='测试添加数据2')
           db.session.add(u)
           db.session.commit()
       except:
           db.session.rollback()
       return '添加一条数据'
   ```

   注意：

   1. `sqlalchemy`默认开启了事务处理
   2. 每次对数据进行处理需要提交或回滚
      - `db.session.commit()`
      - `db.session.rollback()`

2. 添加多条数据

   实例：

   ```python
   # 添加多条数据
   @app.route('/insert_many/')
   def insert_many():
       try:
           u1 = User(username='tony',age=22)
           u2 = User(username='jeccy',age=23)
           db.session.add_all([u1,u2])
           db.session.commit()
       except:
           db.session.rollback()
       return '添加多条数据测试'
   ```

3. 数据查询

   ```python
   # 查询数据
   @app.route('/select/')
   def select():
       u = User.query.get(1)
       print(u)
       print(u.username)
       print(u.age)
       return '查询'
   ```

4. 数据修改

   ```python
   # 修改数据
   @app.route('/update/')
   def update():
       try:
           u = User.query.get(1)
           u.age = 27
           u.sex = True
           db.session.add(u)
           db.session.commit()
       except:
           db.session.rollback()
       return '更新数据'
   ```

5. 数据删除

   ```python
   @app.route('/delete/')
   def delete():
       u = User.query.get(3)
       db.session.delete(u)
       db.session.commit()
       return '删除'
   ```

六、自定义封装模型类增删改的基类

1. 模型类

   实例：

   ```python
   
   ```

2. 