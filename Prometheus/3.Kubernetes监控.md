一、`Kubernetes`监控方案

1. `Heapster`：
   - 对于`Kubernetes`需要考虑的监控项：
     - `Kubernetes`节点，比如节点的`CPU,Load,Disk,Memory`等指标
     - 内部系统组件的状态，比如`kube-scheduler,kube-controller-manager,Kube-DNS/CoreDNS`等
     - 编排级的`metrics`，比如`Deployment,Pod,DaemonSet,StatefulSet`等资源的状态，资源请求，调度和`API`延迟等数据指标
2. `kube-state-metrics`
   - `kube-state-metrics`通过监听`API Server`生成有关资源对象的状态指标，比如：
     - `Deployment`调度了多少个`Pod`副本，现在可用的有几个？
     - 有多少个`Pod`是`running,stopped`或`terminated`状态？
     - `Pod`重启了几次？
3. `kube-state-metrics`和`metric-server`的区别
   - `kube-state-metrics`主要关注集群资源相关的一些元数据，比如`Deployment,Pod`副本状态和资源限额等静态指标。
   - `metric-server`主要关注资源度量`API`的实现，比如`CPU`，文件描述符，内存，请求延时等实时指标。
4. `Prometheus`

二、`Prometheus`的安装配置

1. 基本安装（`k8s`环境）

   1. 创建`namespace`

      `kubectl create ns kube-ops`

   2. 创建`configmap`

   3. 创建`deploy`资源

   4. 定义`ServiceAccount`以及`RBAC`授权

   5. 定义`Service`资源

   `https://github.com/jiangzhiheng/k8sDemo/tree/master/prometheus/simple_install`

2. 安装`Prometheus Operator`

   1. 概述
      - `Operator`是由`CoreOS`公司开发的用来扩展`Kubernetes API`的特定应用程序控制器，用来创建，配置和管理复杂的有状态应用，例如数据库，缓存和监控系统，`Prometheus Operator`就是基于`Operator`框架开发的管理`Prometheus`集群的控制器
      - `Prometheus Operator`架构：
        - `Operator`是核心部分，作为一个控制器而存在，`Operator`会创建`Prometheus,ServiceMonitor,AlertManager及PronetheusRule`这四个`CRD`资源对象，然后一直监控并维持这四个资源对象的状态
        - `Prometheus`资源对象是作为`Prometheus Server`存在的
        - `ServiceMonitor`资源对象是专门提供`Metrics`数据接口的`exporter`的抽象
        - `Alertmanager`资源对象是对应`AlertManager`组件的抽象
        - `PrometheusRule`资源对象是被`Prometheus`实例使用的告警规则文件的抽象
      
   2. 手动部署`Prometheus Operator`
      - `git clone https://gitee.com/jzh_k/kube-prometheus.git`
      - `kubectl create -f manifests/setup`
      - `kubectl create -f manifests/`
      - 配置`grafana`：如果想要安装插件，需要配置`grafana-deployment.yaml`插件存储路径，默认为`emptyDir`
      
   3. 配置`kube-scheduler`和`kube-controller-manager`的监控目标

      - `prometheus-serviceMonitorKubeScheduler.yaml`

        ```yaml
        apiVersion: monitoring.coreos.com/v1
        kind: ServiceMonitor
        metadata:
          labels:
            k8s-app: kube-scheduler
          name: kube-scheduler
          namespace: monitoring
        spec:
          endpoints:
          - interval: 30s   # 30s获取一次信息
            port: http-metrics  # 对应的Service的端口名
          jobLabel: k8s-app
          namespaceSelector:   #表示匹配某名称空间中的service
            matchNames:
            - kube-system
          selector:  # 匹配service
            matchLabels:
              k8s-app: kube-scheduler
        ```

      - `prometheus-kubeSchedulerService.yaml`

        ```yaml
        apiVersion: v1
        kind: Service
        metadata:
          name: kube-scheduler
          namespace: kube-system
          labels:
            k8s-app: kube-scheduler
        spec:
          selector:
            component: kube-scheduler
          ports:
          - name: http-metrics
            port: 10251
            targetPort: 10251
            protocol: TCP
        ```

      - `kubectl apply -f prometheus-kubeSchedulerService.yaml`

3. 在`Prometheus`中添加自定义的监控项

4. 