一、`Kubernetes`监控方案

1. `Heapster`：
   - 对于`Kubernetes`需要考虑的监控项：
     - `Kubernetes`节点，比如节点的`CPU,Load,Disk,Memory`等指标
     - 内部系统组件的状态，比如`kube-scheduler,kube-controller-manager,Kube-DNS/CoreDNS`等
     - 编排级的`metrics`，比如`Deployment,Pod,DaemonSet,StatefulSet`等资源的状态，资源请求，调度和`API`延迟等数据指标
2. `kube-state-metrics`
   - `kube-state-metrics`通过监听`API Server`生成有关资源对象的状态指标，比如：
     - `Deployment`调度了多少个`Pod`副本，现在可用的有几个？
     - 有多少个`Pod`是`running,stopped`或`terminated`状态？
     - `Pod`重启了几次？
3. `kube-state-metrics`和`metric-server`的区别
   - `kube-state-metrics`主要关注集群资源相关的一些元数据，比如`Deployment,Pod`副本状态和资源限额等静态指标。
   - `metric-server`主要关注资源度量`API`的实现，比如`CPU`，文件描述符，内存，请求延时等实时指标。
4. `Prometheus`

二、`Prometheus`的安装配置

1. 基本安装（`k8s`环境）

   1. 创建`namespace`

      `kubectl create ns kube-ops`

   2. 创建`configmap`

   3. 创建`deploy`资源

   4. 定义`ServiceAccount`以及`RBAC`授权

   5. 定义`Service`资源

   `https://github.com/jiangzhiheng/k8sDemo/tree/master/prometheus/simple_install`

2. 安装`Prometheus Operator`

   1. 概述
      - `Operator`是由`CoreOS`公司开发的用来扩展`Kubernetes API`的特定应用程序控制器，用来创建，配置和管理复杂的有状态应用，例如数据库，缓存和监控系统，`Prometheus Operator`就是基于`Operator`框架开发的管理`Prometheus`集群的控制器
      - `Prometheus Operator`架构：
        - `Operator`是核心部分，作为一个控制器而存在，`Operator`会创建`Prometheus,ServiceMonitor,AlertManager及PronetheusRule`这四个`CRD`资源对象，然后一直监控并维持这四个资源对象的状态
        - `Prometheus`资源对象是作为`Prometheus Server`存在的
        - `ServiceMonitor`资源对象是专门提供`Metrics`数据接口的`exporter`的抽象
        - `Alertmanager`资源对象是对应`AlertManager`组件的抽象
        - `PrometheusRule`资源对象是被`Prometheus`实例使用的告警规则文件的抽象
      
   2. 手动部署`Prometheus Operator`
      - `git clone https://gitee.com/jzh_k/kube-prometheus.git`
      - `kubectl create -f manifests/setup`
      - `kubectl create -f manifests/`
      - 配置`grafana`：如果想要安装插件，需要配置`grafana-deployment.yaml`插件存储路径，默认为`emptyDir`
      
   3. 配置`kube-scheduler`和`kube-controller-manager`的监控目标

      - `prometheus-serviceMonitorKubeScheduler.yaml`

        ```yaml
        apiVersion: monitoring.coreos.com/v1
        kind: ServiceMonitor
        metadata:
          labels:
            k8s-app: kube-scheduler
          name: kube-scheduler
          namespace: monitoring
        spec:
          endpoints:
          - interval: 30s   # 30s获取一次信息
            port: http-metrics  # 对应的Service的端口名
          jobLabel: k8s-app
          namespaceSelector:   #表示匹配某名称空间中的service
            matchNames:
            - kube-system
          selector:  # 匹配service
            matchLabels:
              k8s-app: kube-scheduler
        ```

      - `prometheus-kubeSchedulerService.yaml`

        ```yaml
        apiVersion: v1
        kind: Service
        metadata:
          name: kube-scheduler
          namespace: kube-system
          labels:
            k8s-app: kube-scheduler
        spec:
          selector:
            component: kube-scheduler
          ports:
          - name: http-metrics
            port: 10251
            targetPort: 10251
            protocol: TCP
        ```

      - `kubectl apply -f prometheus-kubeSchedulerService.yaml`

3. 在`Prometheus`中添加自定义的监控项

   1. 概述：

      - 首先，建立一个`ServiceMonitor`对象，用于为`Proemtheus`添加监控项
      - 然后，将`ServiceMonitor`对象关联`Metrics`数据接口的一个`Service`对象
      - `Service`对象可以正确获取`Metrics`数据，以下为以配置`Etcd`集群监控为例

   2. 配置步骤

      1. 配置`etcd`证书

         ```shell
         # 查看etcd的livenessProbe
         # 如果需要使用https认证，则将认证使用到的证书通过secret对象保存到集群中
         kubectl -n monitoring create secret generic etcd-certs \
           --from-file=/etc/kubernetes/pki/etcd/healthcheck-client.crt \
           --from-file=/etc/kubernetes/pki/etcd/healthcheck-client.key \
           --from-file=/etc/kubernetes/pki/etcd/ca.key
         ```

         ```shell
         # 将创建的etcd-cert对象配置到prometheus资源对象中
         [root@master ~]# kubectl get prometheus -n monitoring
         NAME   VERSION   REPLICAS   AGE
         k8s    v2.15.2   2          45m
         [root@master ~]# kubectl edit prometheus k8s -n monitoring
           ...
           podMonitorSelector: {}
           replicas: 2
           secrets:
           - etcd-cert
           ...
         ```

      2. 创建`ServiceMonitor`

         ```yaml
         apiVersion: monitoring.coreos.com/v1
         kind: ServiceMonitor
         metadata:
           name: etcd-k8s
           namespace: monitoring
           labels:
             k8s-app: etcd-k8s
         spec:
           jobLabel: k8s-app
           endpoints:
           - port: port
             interval: 30s
             scheme: https
             tlsConfig:
               caFile: /etc/prometheus/secrets/etcd-certs/ca.crt
               certFile: /etc/prometheus/secrets/etcd-certs/healthcheck-client.crt
               keyFile: /etc/prometheus/secrets/etcd-certs/healthcheck-client.key
               insecureSkipVerify: true
           selector:
             matchLabels:
               k8s-app: etcd
           namespaceSelector:
             matchNames:
             - kube-system
         ```

      3. 创建`Service`

         ```yaml
         # etcd集群一般位于集群外，需要手动创建一个Endpoints
         apiVersion: v1
         kind: Service
         metadata:
           name: etcd-k8s
           namespace: kube-system
           labels:
             k8s-app: etcd
         spec:
           type: ClusterIP
           clusterIP: None
           ports:
           - name: port
             port: 2379
             protocol: TCP
         ---
         apiVersion: v1
         kind: Endpoints
         metadata:
           name: etcd-k8s
           namespace: kube-system
           labels:
             k8s-app: etcd
         subsets:
         - addresses:
           - ip: 192.168.1.102
             nodeName: etcd-master
           ports:
           - name: port
             port: 2379
             protocol: TCP
         ```

4. 在`Prometheus Operator`中添加自定义告警