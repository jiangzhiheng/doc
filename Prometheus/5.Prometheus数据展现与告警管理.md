一、`Prometheus`数据展现

1. 在`Kubernetes`中安装`grafana`

   ```yaml
   # grafana.yaml
   apiVersion: apps/v1
   kind: Deployment
   metadata:
     name: grafana
     namespace: kube-ops
     labels:
       app: grafana
   spec:
     replicas: 1
     selector:
       matchLabels:
         app: grafana
     template:
       metadata:
         name: grafana
         labels:
           app: grafana
       spec:
         volumes:
         - name: storage
           hostPath:
             path: /tmp/grafana
         securityContext:
           fsGroup: 472
           runAsUser: 472
         containers:
         - name: grafana
           image: grafana/grafana:5.3.4
           imagePullPolicy: IfNotPresent
           ports:
           - containerPort: 3000
             name: grafana
           env:
           - name: GF_SECURITY_ADMIN_USER
             value: admin
           - name: GF_SECURITY_ADMIN_PASSWORD
             value: admin
           readinessProbe:
             failureThreshold: 10
             httpGet:
               path: /api/health
               port: 3000
               scheme: HTTP
             initialDelaySeconds: 60
             periodSeconds: 10
             successThreshold: 1
             timeoutSeconds: 30
           livenessProbe:
             failureThreshold: 3
             httpGet:
               path: /api/health
               port: 3000
               scheme: HTTP
             periodSeconds: 10
             successThreshold: 1
             timeoutSeconds: 1
           resources:
             limits:
               cpu: 100m
               memory: 256M
             requests:
               cpu: 100m
               memory: 256M
           volumeMounts:
           - name: storage
             mountPath: /var/lib/grafana
             subPath: grafana
   ```

   ```yaml
   # grafana-svc.yaml
   apiVersion: v1
   kind: Service
   metadata:
     name: grafana
     namespace: kube-ops
     labels:
       app: grafana
   spec:
     type: NodePort
     ports:
     - port: 3000
     selector:
       app: grafana
   ```

   `grafana5.1`版本以后，用户`ID`从104变为472，用户组`ID`从107变为472，可以利用一个`Job`来修改权限

   ```yaml
   # grafana-chown.yaml
   apiVersion: batch/v1
   kind: Job
   metadata:
     name: grafana-chown
     namespace: kube-ops
   spec:
     template:
       spec:
         restartPolicy: Never
         containers:
         - name: grafana-chown
           image: busybox:latest
           imagePullPolicy: IfNotPresent
           command: ["chown","-R","472:472","/var/lib/grafana"]
           volumeMounts:
           - name: storage
             mountPath: /var/lib/grafana
             subPath: grafana
         volumes:
         - name: storage
           hostPath:
             path: /tmp/grafana
   ```

2. 配置`grafana`

   1. 数据源

      - 添加数据源
        - `Name`：`prometheus-ds`，自定义
        - `Type`：`Prometheus`
        - `Access`：访问模式
          - 服务器访问模式（默认）：将所有请求都从浏览器`Grafana`后端的服务器，后者又将请求转发到数据源，通过这种方式可以避免一些跨域问题。
          - 浏览器访问模式：将所有请求都从浏览器直接发送到数据源，但可能会有一些跨域限制，使用此访问模式时，需要从浏览器直接访问该`URL`
        - `URL`：数据源地址，由于`Prometheus`和`Grafana`在同一名称空间，则可以直接使用`Service`名称访问，`http:prometheus:9090`

   2. `Daseboard`

      - 创建`Dashboard`，导入`https://grafana.com/grafana/dashboards/162`    741或747两个模板也可参考

        也可下载此文件导入`https://raw.githubusercontent.com/cnych/kubernetes-learning/master/docs/files/grafana-k8s-cluster-dashboard.json`

      - 单击“标题”--->“`Edit`”，修改`PromQL`查询语句

   3. 插件：`https://grafana.com/grafana/plugins/grafana-kubernetes-app`

3. `Grafana`告警

   1. 邮件告警

      - 通过`ConfigMap`将邮件告警配置添加到`Grafana Pod`中。

        ```yaml
        apiVersion: v1
        kind: ConfigMap
        metadata: 
          name: grafana-config
          namespace: kube-ops
        data:
          grafana.ini: |
            [server]
            root_url = http://grafana:3000
            [smtp]
            enable = true
            host = smtp.163.com:25
            user = jiangzh931225@163.com
            password = ***************
            skip_verify = true
            from_address = jiangzh931225@163.com
            [alerting]
            enable = true
            execute_alerts = true
        ```

      - 将`ConfigMap`添加到`Grafana`的`Pod`卷中进行挂载。

二、`Prometheus`告警组件`AlertManager`

1. 安装`AlertManager`

   - 创建`ConfigMap`资源对象

     ```yaml
     apiVersion: v1
     kind: ConfigMap
     metadata:
       name: alert-config
       namespace: kube-ops
     data:
       config.yml: |-
         global:
           # 在没有告警的情况下声明为已解决的时间
           resolve_timeout: 5m
           # 配置邮件发送信息
           smtp_smarthost: 'smtp.163.com:25'
           smtp_from: 'jiangzh931225@163.com'
           smtp_auth_username: 'jiangzh931225@163.com'
           smtp_auth_password: '12345678'
           smtp_hello: '163.com'
           smtp_require_tls: false
           # 所有告警信息进入后的根路由，用于设置告警的分发策略
           route:
             # 这里的标签列表是接收到告警信息后的重新分组标签，例如在接收到的告警信息里与许多具有cluster=A和altername=LatncyHigh标签的告警信息会被批量聚合到一个分组里
             group_by: ['alertname','cluster']
             group_wait: 30s
             # 在第一条告警发送后，等待group_interval时间来发送新的一组告警信息
             group_interval: 5m
             # 如果某条告警信息已经发送成功，则等待repeat_interval时间重新发送它们
             repeat_interval: 5m
             # 如果某条告警没有被一个route匹配，则发送给默认的接收器
             receiver: default
             # 上面的所有属性都由所有子路由继承，并且可以在每个子路由上覆盖
             routes:
             - receiver: email
               group_wait: 10s
               match:
                 team: node
             receivers:
             - name: 'default'
               email_configs:
               - to: '1689991551@qq.com'
                 send_resolved: true
             - name: 'email'
               email_configs:
               - to: '2516202335@qq.com'
               send_resolved: true
     ```

   - 配置`AlterManager`容器：可以直接添加在`Prometheus`的`Pod`中

     ```yaml
           - name: alertmanager
             image: prom/alertmanager:v0.15.3
             imagePullPolicy: IfNotPresent
             args:
             - "--config.file=/etc/alertmanager/config.yml"
             - "--storage.path=/alertmanager/data"
             ports:
             - name: http
               containerPort: 9093
             resources:
               requests:
                 cpu: 100m
                 memory: 256Mi
               limits:
                 cpu: 100m
                 memory: 256Mi
             volumeMounts:
             - name: alertcfg
               mountPath: "/etc/alertmanager"
           volumes:
           - name: alertcfg
             configMap:
               name: alert-config
     ```

     `https://github.com/jiangzhiheng/kubernetes-learning/tree/master/prometheus`

   - 在`Prometheus`中配置`AlertManager`的地址

     ```yaml
     # prometheus-cm.yaml中添加
     alerting:
       alertmanagers:
       - static_configs:
         - targets: [localhost:9093]
     ```

2. 告警规则

