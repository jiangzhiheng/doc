1. ### **Shell条件测试**

   1. 概述

      - 格式1：test 条件表达式

      - 格式2：[ 条件表达式 ]

      ```shell
      #!/bin/bash
      #
      back_dir=/var/mysql_back
      #if ! test -d $back_dir;then
      if [ ! -d $back_dir ];then
              mkdir -p $back_dir
      fi
      
      echo "Start Backup..."
      ```

      ```shell
      #!/bin/bash
      #
      #if [ $UID -ne 0 ];then
      if [ $USER != "root" ];then
              echo "Permission deny!"
              exit
      fi
      
      echo "Start install..."
      
      ```

      - 格式3：[[ 条件表达式 ]]

   2. 文件测试

      [ -e dir/file ]     判断是否存在

      [ -d dir ]

      [ -f file ]   是否存在，而且是文件

      [ -r file ]  当前用户对该文件是否具有读权限

      [ -x file ]

      [ -w file ]

      [ -L file ]   判断是否为链接文件

      [ -b /dev/sda ]  判断是否为块设备

      [ -c /dev/sda ]  判断是否为字符设备

   3. 数值比较

      -gt   大于

      -ge   大于等于

      -lt   小于

      -le   小于等于

      -eq   等于

      -ne   不等于

      ```shell
      #!/bin/bash
      #创建用户脚本
      read -p "Please input a username: " user
      
      if id $user &>/dev/null;then
              echo "user $user already exists"
      else
              /usr/sbin/useradd $user
              if [ $? -eq 0 ];then
                      echo "$user is created"
              fi
      fi
      
      ```

      磁盘使用率告警脚本

      ```shell
      #!/bin/bash
      #判断磁盘使用率，如果使用率大于90%则发邮件给对应用户
      #配置crontab每5分钟执行一次  * /5 * * * 
      disk_use=`df -Th | grep '/$'|awk '{print $(NF-1)}' |awk -F"%" '{print $1}'`
      mail_user=root
      if [ $disk_use -ge 90 ];then
              echo "`date +%F-%H` disk: ${disk_use}%" |mail -s "disk warning.." $mail_user
      fi
      
      ```

      内存使用率告警脚本

      ```shell
      #!/bin/bash
      
      mem_used=`free -m |grep '^Mem'|awk '{print $3}'`
      mem_total=`free -m |grep '^Mem'|awk '{print $2}'`
      
      mem_percent=$((mem_used*100/mem_total))
      
      war_file=/tmp/mem_war.txt
      
      if [ $mem_percent -ge 80 ];then
              echo "`date +%F-%H` memory:${mem_percent}%" > $war_file
      fi
      
      if [ -f $war_file ];then
              mail -s "mem war ..." root < $war_file
              rm -rf $war_file
      fi
      ```

      

   4. 字符串比较

      提示：使用双引号

      [ "$USER"="root" ];echo $?

      [ -z "$BBB" ]    字符长度是为0

      [ -n ""$BBB" ]   字符长度不为0

      [ 1 -lt 2 -a 5 -gt 10 ];echo $?

      [ 1 -lt 2 -0 5 -gt 10 ];echo $?

      [[ 1 -lt 2 && 5 -gt 10 ]];echo $?

      [[ 1 -lt 2 || 5 -gt 10 ]];echo $?

      ```shell
      #!/bin/bash
      #批量创建用户
      read -p "Please input number: " num
      
      while true
      do
              if [[ "$num" =~ ^[0-9]+$ ]];then
                      break
              else
                      echo "Error number"     
                      read -p "Please input number: " num
              fi
      done
      
      
      read -p "Please input prefix: " prefix
      if [ -z "$prefix" ];then
              echo "Error prefix"
              exit
      fi
      
      for i in `seq $num`
      do
              user=$prefix$i
              /usr/sbin/useradd $user
              echo "123456" |passwd --stdin $user &> /dev/null
              if [ $? -eq 0 ];then
                      echo "$user is created"
              fi
      done
      
      #注意正则表达式的使用需要[[  ]]   =~正则匹配
      #  ^[0-9]+$   匹配1到多个数字
      ```

   5. 总结

      () 子Shell中执行

      (())  数值比较，运算

      $()  命令替换

      $(())  整数运算

      {1..5}  集合

      ${}   引用变量

      []  条件测试

      [[ ]]  条件测试 支持正则 =~

      $[ ]  整数运算

2. ### **流程控制**

   1. if语句

      - 单分支结构

        if 条件测试

        then   命令序列

        fi

      - 双分支结构

        if  条件测试

        then 命令序列

        else  命令序列

        fi

      - 多分支结构

        if 条件测试1

        then  命令序列

        [elif  条件测试2

        then  命令序列2]

        [ ...... ]

        fi

        Demo01:安装Apache

        ```shell
        #!/bin/bash
        ####################################
        # Install Apache                   #
        # v0.1 by jiangzhiheng 2019.9.29   #
        #                                  #
        ####################################
        #
        gateway=192.168.1.2
        
        ping -c1 www.baidu.com &> /dev/null
        if [ $? -eq 0 ] &> /dev/null;then
                yum -y install httpd
                systemctl start httpd
                systemctl enable httpd
                #firewall-cmd --permanent --add-service=http
                #firewall-cmd --permanent --add-service=https
                #firewall-cmd --reload
                sed -ri '/^SELINUX/cSELINUX=disabled' /etc/selinux/config
                setenforce 0
                curl http://127.0.0.1 &> /dev/null
                if [ $? -eq 0 ];then
                        echo "Apache is ok"
                fi
        elif ping -c1 $gateway &>/dev/null;then
                echo "check dns..."
        else
                echo "echo ip address!"
        fi
        ```

        Demo02:配置YUM源

        ```shell
        #!/bin/bash
        ####################################
      # Config Yum Repo                  #
        # v0.1 by jiangzhiheng 2019.9.29   #
        #                                  #
        ####################################
        
        os_version=`cat /etc/redhat-release |awk '{print $4}'|awk -F"." '{print $1"."$2}'`
        yum_server=127.0.0.1
        
        [ -d /etc/yum.repos.d ]|| mkdir /etc/yum.repos.d/bak
        mv /etc/yum.repos.d/*.repo /etc/yum.repos.d/bak
        
        if [ "$os_version"="7.6" ];then
        #curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
                cat >/etc/yum.repos.d/centos7u6.repo <<-EOF
                [centos7u6]
                name=centos7u6
                baseurl=ftp://$yum_server/centos7u6
                gpgcheck=0
                EOF
                echo "$os_version YUM configure..."
        elif [ "$os_version"="6.8" ];then
        #curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo
                cat >/etc/yum.repos.d/centos6u8.repo <<-EOF
                [centos6u8]
                name=centos6u8
                baseurl=ftp://$yum_server/centos6u8
                gpgcheck=0
                EOF
                echo "$os_version YUM configure..."
        else
                echo "Error"
        fi
        # 末尾的EOF后面不能带有空格，EOF前后都不应有空格或其他符号
        ```
        
        

   2. 

3. 

