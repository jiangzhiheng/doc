1. 处理不良行为的命令：`changed_when`和`failed_when`

   - `failed_when:False`：保证任务返回失败的时候也不会停止运行`playbook`
   - `chaneged_when`：通过在`out`返回值中添加`changed_when`语句寻找关键字来使`changed`状态改变。例如

   ```yaml
   - name: initialize the database
     django_manage:
       command: createdb --noinput --nodata
       app_path: "{{ proj_path }}" 
       virtualenv: "{{ venv_path }}"
     register: result
     changed_when: '"Create tables" in result.out|default("")' # 使用jinja2过滤器在result.out不存在时分配一个默认值
   ```

2. 过滤器

   - 默认过滤器

     ```jinja2
     "HOST": "{{ database_host | default('localhost') }}",
     ```

     如果变量`database_host`已经被定义，那么直接使用这个值，否则，使用`default`值

   - 用于注册变量的过滤器

     有时候，我们希望无论`task`执行成功与否，都能够打印`task`的输出。不过，如果`task`执行确实失败了，还是希望`Ansible`在打印输出后才使主机失败，我们可以将`failed`过滤器作为`failed_when`语句的参数

     ```yaml
     - name: Run myprog
       command: /opt/myprog
       register: result
       ignore_errors: True
     - debug: var=result
     
     - debug: msg="Stop running the playbook if myprog failed"
       failed_when: result|failed
     ```

     `task`返回值过滤器

     |   名称    |                  描述                   |
     | :-------: | :-------------------------------------: |
     | `failed`  | 如果注册变量的值是`failed`则返回`True`  |
     | `changed` | 如果注册变量的值是`changed`则返回`True` |
     | `success` | 如果注册变量的值是`success`则返回`True` |
     | `skiped`  | 如果注册变量的值是`skiped`则返回`True`  |

   - 应用于文件路径的过滤器

     |     名称     |             描述              |
     | :----------: | :---------------------------: |
     |  `basename`  |      文件路径中的文件名       |
     |  `dirname`   |       文件路径中的目录        |
     | `expanduser` | 将文件路径中的~替换为用户目录 |
     |  `realpath`  | 处理符号链接后的文件实际路径  |

     示例：

     ```yaml
     vars: 
       homepage: /usr/share/nginx/html/index.html
     tasks:
     - name: copy home page
       copy: src=files/index.html dest={{ homepage }}
       
     # 如上引用了两次index.html,basename过滤器可以让我们从全路径中提取文件名部分，例如
     vars: 
       homepage: /usr/share/nginx/html/index.html
     tasks:
     - name: copy home page
       copy: src=files/{{ homepage | basename }} dest={{ homepage }}
     ```

   - 自定义过滤器

3. `lookup`

   1. `Ansible`支持从不同来源获取数据的`lookup`集合

      |    名称    |          描述          |
      | :--------: | :--------------------: |
      |   `file`   |       文件的内容       |
      | `password` |    随机生成一个密码    |
      |   `pipe`   |   本地命令执行的输出   |
      |   `env`    |        环境变量        |
      | `template` | `JinJa2`模板渲染的结果 |
      | `csvfile`  |   `.csv`文件中的条目   |
      |  `dnstxt`  |    `DNS`的`TXT`记录    |
      | `redis_kv` |   `Redis key lookup`   |
      |   `etcd`   |   `etcd key lookup`    |

      使用方式：可以传入两个参数来调用`lookup`函数，第一个参数是使用的`lookup`的名字，第二个参数是传递给`lookup`的参数，例如

      `lookup('file', '/path/to/file.txt')`

   2. `file`

      - 如果你的控制主机上有一个文本文件，这个文本文件中包含有你希望复制到远程主机的`SSH`公钥，例如

        ```yaml
        - name: Add my public key as an EC2 key
          ec2_key: name=mykey key_material="{{ lookup('file', \
          '/User/lorin/.ssh/id_rsa.pub') }}"
        ```

      - 也可以在模板中调用`lookup`。

        `authorized_keys.j2`

        ```jinja2
        {{ lookup('file', '/User/lorin/.ssh/id_rsa.pub') }}
        ```

        ```yaml
        - name: copy authorized_host file
          template: src=authorized_keys.j2 dest=/home/deploy/.ssh/authorized_keys
        ```

   3. `pipe`

      `pipe lookup`在控制主机上调用一个外部程序并将这个程序的输出打印到标准输出

   4. `env`

      `env lookup`的作用是获取控制主机上环境变量的值。例如

      ```yaml
      - name: get the current shell
        debug: msg="{{ lookup('env', 'SHELL') }}"
      ```

   5. `password`

      `password lookup`会随机生成一个密码并且还会将这个密码写入参数指定的文件

      ```yaml
      - name: create deploy postgres user
        postgresql_user:
          name: deploy
          password: "{{ lookup('password', 'deploy-password.txt') }}"
      ```

   6. `template`

      `template lookup`会让你制定一个`JinJa2`模板文件，然后返回这个模板渲染的结果，例如

      ```jinja2
      # message.j2
      this host runs {{ ansible_distribution }}
      ```

      ```yaml
      - name: output message from template
        debug: msg="{{ lookup('template', 'message.j2') }}"
      ```

   7. `csvfile`

      ```yaml
      lookup('csvfile', 'sue file=user.csv delimiter=, col=1')
      # 第一个参数是出现在csv表格中第0列的记录
      # 第二个参数指定csv文件
      # 第三个参数指定分隔符
      # 第四个参数指定要返回的列
      ```

   8. `dnstxt`

   9. `redis_kv`

      `redis-cli SET weather sunny`

      ```
      - name: look up value
      ```

   10. 

4. 