1. 处理不良行为的命令：`changed_when`和`failed_when`

   - `failed_when:False`：保证任务返回失败的时候也不会停止运行`playbook`
   - `chaneged_when`：通过在`out`返回值中添加`changed_when`语句寻找关键字来使`changed`状态改变。例如

   ```yaml
   - name: initialize the database
     django_manage:
       command: createdb --noinput --nodata
       app_path: "{{ proj_path }}" 
       virtualenv: "{{ venv_path }}"
     register: result
     changed_when: '"Create tables" in result.out|default("")' # 使用jinja2过滤器在result.out不存在时分配一个默认值
   ```

2. 过滤器

   - 默认过滤器

     ```jinja2
     "HOST": "{{ database_host | default('localhost') }}",
     ```

     如果变量`database_host`已经被定义，那么直接使用这个值，否则，使用`default`值

   - 用于注册变量的过滤器

     有时候，我们希望无论`task`执行成功与否，都能够打印`task`的输出。不过，如果`task`执行确实失败了，还是希望`Ansible`在打印输出后才使主机失败，我们可以将`failed`过滤器作为`failed_when`语句的参数

     ```yaml
     - name: Run myprog
       command: /opt/myprog
       register: result
       ignore_errors: True
     - debug: var=result
     
     - debug: msg="Stop running the playbook if myprog failed"
       failed_when: result|failed
     ```

     `task`返回值过滤器

     |   名称    |                  描述                   |
     | :-------: | :-------------------------------------: |
     | `failed`  | 如果注册变量的值是`failed`则返回`True`  |
     | `changed` | 如果注册变量的值是`changed`则返回`True` |
     | `success` | 如果注册变量的值是`success`则返回`True` |
     | `skiped`  | 如果注册变量的值是`skiped`则返回`True`  |

   - 应用于文件路径的过滤器

     |     名称     |             描述              |
     | :----------: | :---------------------------: |
     |  `basename`  |      文件路径中的文件名       |
     |  `dirname`   |       文件路径中的目录        |
     | `expanduser` | 将文件路径中的~替换为用户目录 |
     |  `realpath`  | 处理符号链接后的文件实际路径  |

     示例：

     ```yaml
     vars: 
       homepage: /usr/share/nginx/html/index.html
     tasks:
     - name: copy home page
       copy: src=files/index.html dest={{ homepage }}
       
     # 如上引用了两次index.html,basename过滤器可以让我们从全路径中提取文件名部分，例如
     vars: 
       homepage: /usr/share/nginx/html/index.html
     tasks:
     - name: copy home page
       copy: src=files/{{ homepage | basename }} dest={{ homepage }}
     ```

   - 自定义过滤器

3. 